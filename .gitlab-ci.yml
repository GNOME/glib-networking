image: fedora:28

variables:
  ADDITIONAL_DEPENDENCIES: gsettings-desktop-schemas gcc libasan openssl-devel
  ADDITIONAL_DEBUG_INFO: openssl

build_stable:
  before_script:
    - dnf update -y --nogpgcheck --enablerepo=updates-testing
    - dnf install -y 'dnf-command(builddep)'
    - dnf builddep -y --nogpgcheck glib-networking
    - dnf install -y --nogpgcheck $ADDITIONAL_DEPENDENCIES
    - dnf -y debuginfo-install $ADDITIONAL_DEBUG_INFO
  script:
    - mkdir build
    - cd build
    - meson .. -Dopenssl=auto -Db_sanitize=address
    - ninja
    - ninja test
    - ninja install
  artifacts:
    paths:
      - build/test-results
    when: on_failure
