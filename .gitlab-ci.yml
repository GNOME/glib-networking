image: registry.gitlab.gnome.org/gnome/glib-networking/master:v8

fedora-x86_64:
  tags: [ privileged ]
  stage: build
  script:
    # Sadly, GCC 9's LeakSanitizer is quite crashy, #86.
    # So we will run our tests under asan only once.
    - meson -Db_sanitize=address
            -Dgnutls=enabled
            -Dopenssl=enabled
            -Dlibproxy=enabled
            -Dgnome_proxy=enabled
            -Dwerror=true
            build/
    - ninja -C build/
    - ASAN_OPTIONS=fast_unwind_on_malloc=0 meson test --verbose --timeout-multiplier=10 -C build/
    - rm -rf build/

    # Now again, this time without asan. We will additionally test installation.
    - meson --prefix=$HOME/glib-networking-installed
            -Dgnutls=enabled
            -Dopenssl=enabled
            -Dlibproxy=enabled
            -Dgnome_proxy=enabled
            -Dwerror=true
            build/
    - ninja -C build/
    - meson test -v -C build/ --repeat=500
    - meson install -C build/
  artifacts:
    paths:
      - build/test-results
    when: on_failure

vs2017-x64:
  stage: build
  except:
    - tags
  tags:
    - win32
  script:
    - .gitlab-ci/test-msvc.bat
  artifacts:
    paths:
      - build/test-results
    when: on_failure
